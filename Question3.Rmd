---
title: "Temperature Data Manipulation"
author: Ivelin Angelov, Laura Bishop, Ethan Graham, Scott Gozdzialski
output: 
  html_document: default
---

# Temperature Exercise - Question 3

The main lesson around the Temperature data is manipulating a big data set, date format manipulation, and the split-apply-combine across the data set.

## Country Temperature
For the first part of question 3 (i), the goal is to find the difference between the maximum and the minimum monthly average 
temperatures for each country.  Then report/visualize top 20 countries 
with the maximum differences for the period since 1900.

###Clean the Data
First we need to clean the data for Temperature.  Temperature needed significant Date manipulation to make the format consistent.
```{r}
##### TEMPERATURE - Question 3 (i) #####
df <- read.csv(file.path('data', "TEMP.csv"), header=TRUE, sep=',')

# remove unneeded fields
df <- df[, -3]

# rename the rows
names(df) <- c('Date', 'Temperature', 'Country')

# remove nan rows
df <- na.omit(df)

# convert 'Temperature' column to numeric tyope
df$Temperature = as.numeric(df$Temperature)

# convert Date field to type Date
df$Date = as.character(df$Date)
# work on rows with '-' in date
dash_rows = grep('-', df$Date)
df$Date[dash_rows] = as.character(as.Date(df$Date[dash_rows], "%Y-%m-%d"))
# work on rows with '/' in date
slash_rows = grep('/', df$Date)
df$Date[slash_rows] = as.character(as.Date(df$Date[slash_rows], "%d/%m/%Y"))
# convert to type Date
df$Date = as.Date(df$Date)

write.table(df, file.path('data', "TEMP_clean.csv"), row.names = FALSE, sep=',')
cat("Temp.csv was cleaned into TEMP_clean.csv successfully!\n")
```

###Data Manipulation for Question 3 (i)
Manipulate and plot the top 20 differences between maximum and minimum temperatures for countries.

```{r}
#Step 1. Build Data.Frame with rows from 1900-01-01 and greater.
library(plyr)
library(ggplot2)

#Read clean data
temp1900 <- read.csv(file.path('data', "TEMP_clean.csv"), colClasses=c("Date", 'numeric', 'character'), sep=',')

#Date came in as factor so change to Date class. 
temp1900$Date <- as.Date(temp1900$Date)

temp1900 <- subset(temp1900, Date >= as.Date("1900-01-01"))

#Start the plyr split-apply-combine with difference between country max and min Monthly.AverageTemp. Compute the difference between maximum & minimum temperature and order the result.

df_summarise <- ddply(temp1900, .(Country), summarise,
                      temp_min = min(Temperature), temp_max = max(Temperature))
df_summarise$difference <- c(df_summarise$temp_max-df_summarise$temp_min)

#Order the output and display it
df_ordered <- df_summarise[order(-df_summarise$difference),]
#Skinny down data frame to only what needs to be plotted
df_skinny<- df_ordered[1:20,c(1,4)]

```


##City Temperature
For the third part of question 3,  (iii), the goal is to find the difference between the maximum and the minimum monthly average 
temperatures for each city listed in the data set.  Then report/visualize top 20 cities with the maximum differences for the period since 1900.

###Clean the Data
CityTemp was cleaned in a similar fashion.  CityTemp did not have the date format issues that Temprature did.
```{r}
##### CityTemp #######################
dfCity <- read.csv(file.path('data', "CityTemp.csv"), header=TRUE, sep=',', stringsAsFactors = FALSE)

# keep only needed columns
# do we only need those 3?
dfCity <- dfCity[, c(1,2,5,4)]

# remove nan rows
dfCity <- na.omit(dfCity)
tail(dfCity)
# rename the rows
names(dfCity) <- c('Date', 'Temperature', 'Country', 'City')

# leave Date as character in order to get search to align.
dfCity$Date = as.character(dfCity$Date)
# convert 'Temperature' column to numeric tyope
dfCity$Temperature = as.numeric(dfCity$Temperature)

write.table(dfCity, file.path('data', "CityTemp_clean.csv"), row.names = FALSE, sep=',')

cat("CityTemp.csv was cleaned into CityTemp_clean.csv successfully!\n")


```

###Data Manipulation for Question (iii)
Manipulate and plot the top 20 differences between maximum and minimum temperatures for cities.

```{r}
CityTemp1900 <- read.csv(file.path('data', "CityTemp_clean.csv"), colClasses=c("Date", 'numeric', 'character', 'character'), sep=',')

#Change to character class to do string compare.
CityTemp1900$Date <- as.character(CityTemp1900$Date)
CityTemp1900 <- na.omit(CityTemp1900)
CityTemp1900 <- subset(CityTemp1900, Date >= as.character("1/1/1900"))

#Start the plyr split-apply-combine with difference between city max and min Temperature. Compute the difference between maximum & minimum #Temperature and order the result.

dfCity_summarise <- ddply(CityTemp1900, .(City), summarise,
                      temp_min = min(Temperature), temp_max = max(Temperature))
dfCity_summarise$difference <- c(dfCity_summarise$temp_max-dfCity_summarise$temp_min)

#Order
dfCity_ordered <- dfCity_summarise[order(-dfCity_summarise$difference),]
#Skinny down data frame to only what needs to be plotted
dfCity_skinny<- dfCity_ordered[1:20,c(1,4)]



```

#Analysis of the Country and City Plots
## The Top 20 City & Country Temperature Swings
The variability in Temperature swings, as defined by maximum monthly temperature - minimum monthly temperature, is not as large as one would think.  In the top 20 Countries and Cities with the largest swings since 1900, the variability ranges between 31 and 49 degrees.  For City, in which 50% of the Cities are in China, their is an 18.04 degree average difference.  China, with an average temperature difference of 32.255, did not make the top 20 Countries with the largest difference.  For Country, there is a 13.89 degree difference between the average min and max.  All of the top 20 Countries are located in the northern part of the Northern Hemisphere, with Tajikistan being the southern most Country.  There seems to be a line of further research around temperature change in the northern most Countries of our world and Cities in China.

```{r echo=FALSE, fig.height=5, fig.width=3.5, fig.show='hold', out.extra='style="float:left"'}
#plot
ggplot(data=df_skinny, aes(x=Country, y=difference, fill=factor(difference))) +
     geom_bar(position="dodge",stat="identity") +
     geom_col(position = "stack", show.legend = FALSE, inherit.aes = TRUE) +
     coord_flip() +
     ylab("Scale for Difference in Max - Min\n Monthly Average Temp") +
     xlab("Countries") +
     ggtitle("Swing in Monthly Average\nTop 20 Countries") +
     scale_fill_grey() +
     theme(aspect.ratio = 2/1) +
     theme(legend.position="none")

ggplot(data=dfCity_skinny, aes(x=City, y=difference, fill=factor(difference))) +
  geom_bar(position="dodge",stat="identity") +
  geom_col(position = "stack", show.legend = FALSE, inherit.aes = TRUE) +
  coord_flip() +
  ylab("Scale for Difference in Max - Min\n Monthly Average Temp") +
  xlab("Cities") +
  ggtitle("Swing in Monthly Average\nTop 20 Cities") +
  scale_fill_grey() +
  theme(aspect.ratio = 2/1) +
  theme(legend.position="none")

```
